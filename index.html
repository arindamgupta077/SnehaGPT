<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <title>SnehaGPT</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SnehaGPT">
    <meta name="description" content="SnehaGPT - Your personal AI assistant created by Sneha">
    <meta name="keywords" content="AI, chatbot, assistant, SnehaGPT">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'><path d='m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z'/></svg>">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236366f1'><path d='m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Mobile-first responsive design */
        * {
            box-sizing: border-box;
        }
        
        html {
            height: 100%;
            overflow-x: hidden;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            position: relative;
        }
        
        /* Mobile-specific body adjustments */
        @media (max-width: 768px) {
            body {
                height: 100vh;
                height: 100dvh; /* Dynamic viewport height for mobile */
                overflow: hidden;
            }
            
            /* Fix main layout for mobile */
            .mobile-layout {
                height: 100vh;
                height: 100dvh;
                display: flex;
                flex-direction: column;
                overflow: hidden;
            }
            
            /* Mobile chat container */
            #chat-container {
                height: calc(100vh - 140px);
                height: calc(100dvh - 140px);
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                padding: 1rem;
            }
            
            /* Mobile header */
            header {
                flex-shrink: 0;
                height: auto;
                min-height: 60px;
            }
            
            /* Mobile input area */
            #chat-form {
                flex-shrink: 0;
                margin: 0 1rem 1rem 1rem;
            }
            
            /* Mobile welcome screen */
            #welcome-screen {
                height: calc(100vh - 200px);
                height: calc(100dvh - 200px);
                padding: 2rem 1rem;
            }
            
            /* Mobile modals */
            .modal-content {
                max-height: 90vh;
                max-height: 90dvh;
                margin: 1rem;
            }
            
            /* Mobile message bubbles */
            .message {
                max-width: 100%;
                margin: 0.5rem 0;
            }
            
            .message-content {
                padding: 0.75rem;
                font-size: 0.9rem;
                line-height: 1.4;
            }
            
            /* Mobile buttons */
            button {
                min-height: 44px; /* iOS touch target size */
                touch-action: manipulation;
            }
            
            /* Mobile input fields */
            input, textarea, select {
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 44px;
            }
            
            /* Keyboard open adjustments */
            .keyboard-open #chat-container {
                height: calc(100vh - 200px) !important;
                height: calc(100dvh - 200px) !important;
            }
            
            .keyboard-open #welcome-screen {
                height: calc(100vh - 250px) !important;
                height: calc(100dvh - 250px) !important;
            }
        }
        
        /* Extra small mobile devices */
        @media (max-width: 480px) {
            #chat-container {
                padding: 0.75rem;
            }
            
            #chat-form {
                margin: 0 0.75rem 0.75rem 0.75rem;
            }
            
            .message-content {
                padding: 0.5rem;
                font-size: 0.85rem;
            }
            
            #welcome-screen {
                padding: 1rem 0.75rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
            
            .text-3xl {
                font-size: 1.75rem;
            }
        }
        body::-webkit-scrollbar, #chat-history-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, and Opera */
        }
        #chat-container::-webkit-scrollbar {
            width: 6px;
        }
        #chat-container::-webkit-scrollbar-track {
            background: #1e1e1e;
        }
        #chat-container::-webkit-scrollbar-thumb {
            background-color: #4f4f4f;
            border-radius: 20px;
            border: 3px solid #1e1e1e;
        }
        #chat-history-container {
             scrollbar-width: thin;
             scrollbar-color: #4f4f4f #1e1e1e;
        }
        #chat-history-container:hover::-webkit-scrollbar {
            display: block;
        }
         #chat-history-container::-webkit-scrollbar {
            width: 8px;
        }
        #chat-history-container::-webkit-scrollbar-thumb {
            background-color: #4f4f4f;
            border-radius: 4px;
        }
        .message-bubble {
            opacity: 0;
            transform: translateY(20px);
            animation: slideUp 0.5s ease-out forwards;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: #9ca3af;
            display: inline-block; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        
        .modal-overlay {
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content {
            transform: scale(0.95); transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content { transform: scale(1); }
        
        .loader {
            width: 48px; height: 48px; border: 5px solid #FFF;
            border-bottom-color: #6366f1; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile sidebar styles */
        @media (max-width: 768px) {
            #sidebar {
                width: 280px;
            }
            
            #sidebar-overlay {
                backdrop-filter: blur(4px);
            }
            
            /* Prevent body scroll when sidebar is open */
            body.sidebar-open {
                overflow: hidden;
            }
            
            /* Mobile sidebar button styling */
            #mobile-sidebar-btn {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 200 !important;
                position: relative;
                background-color: rgba(0, 0, 0, 0.1);
                backdrop-filter: blur(4px);
                border-radius: 8px;
                transition: all 0.2s ease;
            }
            
            #mobile-sidebar-btn:hover {
                background-color: rgba(0, 0, 0, 0.2);
            }
            
            /* Ensure mobile sidebar button is always visible */
            #mobile-sidebar-btn {
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            
            /* Mobile message improvements */
            .message-bubble .group {
                max-width: 100% !important;
            }
            
            .message-bubble .group > div:last-child {
                max-width: calc(100vw - 80px);
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* Mobile input improvements */
            #message-input {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 12px;
            }
            
            /* Touch-friendly buttons */
            button, .clickable {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Mobile modal improvements */
            .modal-content {
                margin: 1rem;
                max-height: calc(100vh - 2rem);
                border-radius: 1rem;
            }
            
            /* Better mobile scrolling */
            #chat-container {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* Mobile chat history styling */
            #chat-history-container {
                padding: 0.5rem;
            }
            
            #chat-history-container .group {
                padding: 12px;
                margin-bottom: 8px;
            }
        }
        
        /* Touch device optimizations */
        .touch-manipulation {
            touch-action: manipulation;
        }
        
        /* Smooth transitions */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        
        #sidebar-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        
        /* Prevent text selection on buttons */
        button, .clickable {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Mobile dropdown menu z-index fix */
        #mobile-menu {
            z-index: 9999 !important;
            position: absolute !important;
        }
        
        /* Ensure mobile menu stays above chat content */
        @media (max-width: 640px) {
            #mobile-menu {
                z-index: 9999 !important;
                position: absolute !important;
                transform: translateZ(0); /* Force hardware acceleration */
                will-change: transform; /* Optimize for animations */
                isolation: isolate; /* Create new stacking context */
            }
            
            /* Ensure mobile menu container has proper stacking context */
            .sm\\:hidden.relative {
                z-index: 1000;
                position: relative;
            }
            
            /* More specific selector for mobile menu container */
            div.sm\\:hidden.relative {
                z-index: 1000 !important;
            }
            
            /* Ensure chat content doesn't interfere */
            #chat-container {
                z-index: 1;
                position: relative;
            }
            
            /* Ensure header stays above chat content */
            header {
                z-index: 100;
                position: relative;
            }
            
            
            /* Prevent any overflow clipping */
            .sm\\:hidden.relative {
                overflow: visible !important;
            }
        }
        /* Styling for parsed markdown */
        .prose { color: inherit; }
        .prose strong { font-weight: 600; color: inherit; }
        .prose ul { list-style-type: disc; margin-left: 1.5rem; }
        .prose li { margin-top: 0.25rem; }
        .prose p { margin-bottom: 0.5rem; }
        .prose p:last-child { margin-bottom: 0; }
        .prose a { color: #818cf8; text-decoration: underline; }
        .prose table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .prose th, .prose td { border: 1px solid #4b5563; padding: 0.5rem 0.75rem; text-align: left; }
        .prose th { background-color: #374151; font-weight: 600; }
        .prose pre { background-color: #1f2937; padding: 1rem; border-radius: 0.5rem; white-space: pre-wrap; word-wrap: break-word; }
        .prose code { color: #d1d5db; font-family: monospace; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex h-screen overflow-hidden">

    <!-- Sidebar -->
    <aside id="sidebar" class="bg-gray-950 w-72 p-4 flex-shrink-0 flex flex-col fixed inset-y-0 left-0 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:inset-auto">
        <div class="flex items-center gap-2 border-b border-gray-700 pb-4 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
            <h1 class="text-xl font-semibold">SnehaGPT</h1>
            <!-- Mobile close button -->
            <button id="close-sidebar-btn" class="md:hidden ml-auto text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto pr-2" id="chat-history-container">
            <!-- Chat history will be populated here -->
        </div>
    </aside>

    <!-- Mobile sidebar overlay -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 md:hidden hidden"></div>

    <!-- Main Chat Area -->
    <main class="flex-1 flex flex-col bg-gray-800 mobile-layout">
        <header class="bg-gray-900/50 backdrop-blur-sm p-4 border-b border-gray-700 flex items-center justify-between relative z-10">
             <div class="flex items-center gap-2">
                <!-- Mobile menu button for sidebar -->
                <button id="mobile-sidebar-btn" class="md:hidden text-gray-400 hover:text-white p-2 -ml-2 touch-manipulation">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                </button>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                <h1 class="text-xl font-semibold">SnehaGPT</h1>
            </div>
            
            <!-- Action Buttons in Header -->
            <div class="flex items-center gap-2">
                <!-- Desktop buttons -->
                <div class="hidden lg:flex items-center gap-2">
                    <button id="new-chat-btn" class="bg-indigo-500 hover:bg-indigo-600 rounded-lg px-3 py-2 text-white transition-colors duration-200 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        New Chat
                    </button>
                    
                    <button id="code-helper-btn" class="bg-gray-700 hover:bg-gray-600 rounded-lg px-3 py-2 text-white transition-colors duration-200 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                        Code Helper
                    </button>
                    
                    <button id="email-draft-btn" class="bg-gray-700 hover:bg-gray-600 rounded-lg px-3 py-2 text-white transition-colors duration-200 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                        Draft Email
                    </button>
                    
                    <button id="persona-btn" class="bg-gray-700 hover:bg-gray-600 rounded-lg px-3 py-2 text-white transition-colors duration-200 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                        Change Persona
                    </button>
                    
                    <button id="summarize-btn" class="bg-gray-700 hover:bg-gray-600 rounded-lg px-3 py-2 text-white transition-colors duration-200 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="16" x2="13" y2="16"></line></svg>
                        Summarize
                    </button>
                    
                    <button id="image-gen-btn" class="bg-gray-700 hover:bg-gray-600 rounded-lg px-3 py-2 text-white transition-colors duration-200 flex items-center gap-2 text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="m8 12 4 4 4-4"/><path d="M12 16V3"/></svg>
                        Generate Image
                    </button>
                </div>
                
                <!-- Medium screen buttons (icons only) -->
                <div class="hidden sm:flex lg:hidden items-center gap-1">
                    <button id="new-chat-btn-md" class="bg-indigo-500 hover:bg-indigo-600 rounded-lg p-2 text-white transition-colors duration-200" title="New Chat">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    
                    <button id="code-helper-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Code Helper">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                    </button>
                    
                    <button id="email-draft-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Draft Email">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </button>
                    
                    <button id="persona-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Change Persona">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                    </button>
                    
                    <button id="summarize-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Summarize">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="16" x2="13" y2="16"></line></svg>
                    </button>
                    
                    <button id="image-gen-btn-md" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Generate Image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="m8 12 4 4 4-4"/><path d="M12 16V3"/></svg>
                    </button>
                </div>
                
                <!-- Mobile dropdown menu -->
                <div class="sm:hidden relative">
                    <button id="mobile-menu-btn" class="bg-gray-700 hover:bg-gray-600 rounded-lg p-2 text-white transition-colors duration-200" title="Menu">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
                    </button>
                    
                    <div id="mobile-menu" class="absolute right-0 top-full mt-2 w-48 bg-gray-800 rounded-lg shadow-lg border border-gray-700 hidden z-[9999] shadow-2xl">
                        <div class="py-2">
                            <button id="new-chat-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                New Chat
                            </button>
                            <button id="code-helper-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"></polyline><polyline points="8 6 2 12 8 18"></polyline></svg>
                                Code Helper
                            </button>
                            <button id="email-draft-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                                Draft Email
                            </button>
                            <button id="persona-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
                                Change Persona
                            </button>
                            <button id="summarize-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line><line x1="8" y1="8" x2="16" y2="8"></line><line x1="8" y1="16" x2="13" y2="16"></line></svg>
                                Summarize
                            </button>
                            <button id="image-gen-btn-mobile" class="w-full text-left px-4 py-2 text-white hover:bg-gray-700 flex items-center gap-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><path d="m8 12 4 4 4-4"/><path d="M12 16V3"/></svg>
                                Generate Image
                            </button>
                            <button id="install-app-btn-mobile" class="w-full text-left px-4 py-2 text-indigo-300 hover:bg-indigo-700/30 flex items-center gap-3 border-t border-gray-600 mt-2 pt-3">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7,10 12,15 17,10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                                Install App
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 lg:p-8 space-y-6" style="height: calc(100vh - 140px);">
            <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                <div class="bg-indigo-500/20 text-indigo-300 rounded-full p-4 mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>
                </div>
                <h2 class="text-3xl font-bold text-white mb-2">Hello, I'm SnehaGPT</h2>
                <p class="text-gray-400 max-w-md">I'm your personal AI assistant. How can I help you today?</p>
            </div>
        </div>
        
        <div id="suggested-prompts-container" class="px-4 md:px-6 pb-2">
            <div class="max-w-3xl mx-auto flex gap-2 flex-wrap justify-center"></div>
        </div>
        
        <div class="p-4 md:p-6 bg-gray-800 border-t border-gray-700">
             <div id="image-preview-container" class="max-w-3xl mx-auto hidden items-center gap-2 bg-gray-700/50 p-2 rounded-lg mb-2">
                <img id="image-preview" src="" class="w-16 h-16 object-cover rounded-md">
                <div class="flex-1 text-sm text-gray-300">Image attached.</div>
                <button id="remove-image-btn" class="p-1 text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="persona-indicator" class="max-w-3xl mx-auto text-xs text-gray-400 mb-2 h-4"></div>
            <form id="chat-form" class="max-w-3xl mx-auto bg-gray-700 rounded-xl p-2 flex items-center gap-2">
                <button type="button" id="suggest-prompts-btn" title="Suggest Prompts" class="text-gray-400 hover:text-white p-2 rounded-lg transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/></svg>
                </button>
                <input type="file" id="image-upload-input" class="hidden" accept="image/png, image/jpeg, image/webp">
                <button type="button" id="attach-image-btn" title="✨ Attach Image" class="text-gray-400 hover:text-white p-2 rounded-lg transition-colors duration-200">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </button>
                <input type="text" id="message-input" placeholder="Message SnehaGPT..." class="flex-1 bg-transparent text-gray-200 placeholder-gray-400 focus:outline-none px-3 py-2">
                <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 rounded-lg p-3 text-white transition-colors duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </button>
            </form>
        </div>
    </main>

    <!-- Modals -->
    <div id="summary-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">Conversation Summary</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div id="summary-content" class="p-6 overflow-y-auto text-gray-300"></div>
        </div>
    </div>
    
    <div id="image-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">✨ Generate an Image</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6">
                <form id="image-form">
                    <textarea id="image-prompt-input" rows="3" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., A photo of an astronaut riding a horse on Mars..."></textarea>
                    <button type="submit" class="w-full mt-4 bg-indigo-500 hover:bg-indigo-600 rounded-lg p-3 text-lg font-semibold transition-colors duration-200">Generate</button>
                </form>
                <div id="image-display-area" class="mt-4 min-h-[256px] bg-gray-900 rounded-lg flex items-center justify-center"></div>
            </div>
        </div>
    </div>

    <div id="persona-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">✨ Select a Persona</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div id="persona-options" class="p-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Persona buttons will be injected here -->
            </div>
        </div>
    </div>
    
    <div id="fact-check-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">✨ Fact-Check with Google</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div id="fact-check-content" class="p-6 overflow-y-auto text-gray-300"></div>
        </div>
    </div>
    
    <div id="email-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">✨ Draft an Email</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6">
                <form id="email-form" class="space-y-4">
                    <input id="email-to-input" type="text" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400" placeholder="Recipient (e.g., My Manager)">
                    <select id="email-tone-select" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200">
                        <option>Formal</option><option>Casual</option><option>Friendly</option><option>Direct</option>
                    </select>
                    <textarea id="email-prompt-input" rows="3" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400" placeholder="Goal of the email (e.g., Ask for a 3-day vacation next month)"></textarea>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 rounded-lg p-3 font-semibold transition-colors">Draft Email</button>
                </form>
                <div id="email-result-area" class="mt-4 hidden">
                    <div class="flex items-center justify-between">
                         <label class="font-semibold text-gray-400 text-sm">SUBJECT</label>
                         <button id="copy-subject-btn" class="text-xs bg-gray-600 px-2 py-1 rounded">Copy</button>
                    </div>
                    <div id="email-subject-output" class="p-2 bg-gray-900 rounded mt-1 mb-3"></div>
                    <div class="flex items-center justify-between">
                        <label class="font-semibold text-gray-400 text-sm">BODY</label>
                        <button id="copy-body-btn" class="text-xs bg-gray-600 px-2 py-1 rounded">Copy</button>
                    </div>
                    <div id="email-body-output" class="p-2 bg-gray-900 rounded mt-1 h-48 overflow-y-auto whitespace-pre-wrap"></div>
                    <button id="insert-email-btn" class="w-full mt-4 bg-gray-600 hover:bg-gray-500 rounded-lg p-3 font-semibold transition-colors">Insert into Chat</button>
                </div>
                 <div id="email-loading-area" class="mt-4 hidden min-h-[200px] bg-gray-900 rounded-lg flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="code-helper-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
        <div class="modal-content bg-gray-800 rounded-2xl shadow-xl max-w-2xl w-full flex flex-col">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center"><h3 class="text-xl font-semibold text-white">✨ Code Helper</h3><button class="close-modal-btn text-gray-400 hover:text-white">&times;</button></div>
            <div class="p-6">
                <form id="code-helper-form" class="space-y-4">
                    <select id="code-lang-select" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200">
                        <option>JavaScript</option><option>Python</option><option>HTML</option><option>CSS</option><option>SQL</option><option>Java</option><option>C++</option>
                    </select>
                    <textarea id="code-prompt-input" rows="3" class="w-full bg-gray-700 rounded-lg p-3 text-gray-200 placeholder-gray-400" placeholder="Describe the code you need (e.g., a function to reverse a string)"></textarea>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 rounded-lg p-3 font-semibold transition-colors">Generate Code</button>
                </form>
                <div id="code-result-area" class="mt-4 hidden">
                    <div class="flex items-center justify-between">
                         <label class="font-semibold text-gray-400 text-sm">CODE</label>
                         <button id="copy-code-btn" class="text-xs bg-gray-600 px-2 py-1 rounded">Copy</button>
                    </div>
                    <pre class="bg-gray-900 rounded mt-1 mb-3 p-2 h-48 overflow-y-auto"><code id="code-output" class="text-sm"></code></pre>
                    <label class="font-semibold text-gray-400 text-sm">EXPLANATION</label>
                    <div id="code-explanation-output" class="p-2 bg-gray-900 rounded mt-1 max-h-32 overflow-y-auto prose prose-sm"></div>
                    <button id="insert-code-btn" class="w-full mt-4 bg-gray-600 hover:bg-gray-500 rounded-lg p-3 font-semibold transition-colors">Insert into Chat</button>
                </div>
                 <div id="code-loading-area" class="mt-4 hidden min-h-[200px] bg-gray-900 rounded-lg flex items-center justify-center">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>


<script>
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const welcomeScreen = document.getElementById('welcome-screen');
    const newChatBtn = document.getElementById('new-chat-btn');
    const summarizeBtn = document.getElementById('summarize-btn');
    const imageGenBtn = document.getElementById('image-gen-btn');
    const personaBtn = document.getElementById('persona-btn');
    const emailDraftBtn = document.getElementById('email-draft-btn');
    const codeHelperBtn = document.getElementById('code-helper-btn');
    
    // Mobile elements
    const mobileMenuBtn = document.getElementById('mobile-menu-btn');
    const mobileMenu = document.getElementById('mobile-menu');
    const newChatBtnMobile = document.getElementById('new-chat-btn-mobile');
    const codeHelperBtnMobile = document.getElementById('code-helper-btn-mobile');
    const emailDraftBtnMobile = document.getElementById('email-draft-btn-mobile');
    const personaBtnMobile = document.getElementById('persona-btn-mobile');
    const summarizeBtnMobile = document.getElementById('summarize-btn-mobile');
    const imageGenBtnMobile = document.getElementById('image-gen-btn-mobile');
    
    // Medium screen elements
    const newChatBtnMd = document.getElementById('new-chat-btn-md');
    const codeHelperBtnMd = document.getElementById('code-helper-btn-md');
    const emailDraftBtnMd = document.getElementById('email-draft-btn-md');
    const personaBtnMd = document.getElementById('persona-btn-md');
    const summarizeBtnMd = document.getElementById('summarize-btn-md');
    const imageGenBtnMd = document.getElementById('image-gen-btn-md');
    const suggestPromptsBtn = document.getElementById('suggest-prompts-btn');
    const suggestedPromptsContainer = document.getElementById('suggested-prompts-container').querySelector('div');
    const chatHistoryContainer = document.getElementById('chat-history-container');
    const personaIndicator = document.getElementById('persona-indicator');

    // Image Analysis Elements
    const attachImageBtn = document.getElementById('attach-image-btn');
    const imageUploadInput = document.getElementById('image-upload-input');
    const imagePreviewContainer = document.getElementById('image-preview-container');
    const imagePreview = document.getElementById('image-preview');
    const removeImageBtn = document.getElementById('remove-image-btn');

    // Modals and their content
    const summaryModal = document.getElementById('summary-modal');
    const summaryContent = document.getElementById('summary-content');
    const imageModal = document.getElementById('image-modal');
    const imageForm = document.getElementById('image-form');
    const imagePromptInput = document.getElementById('image-prompt-input');
    const imageDisplayArea = document.getElementById('image-display-area');
    const personaModal = document.getElementById('persona-modal');
    const personaOptions = document.getElementById('persona-options');
    const factCheckModal = document.getElementById('fact-check-modal');
    const factCheckContent = document.getElementById('fact-check-content');
    const emailModal = document.getElementById('email-modal');
    const emailForm = document.getElementById('email-form');
    const emailToInput = document.getElementById('email-to-input');
    const emailToneSelect = document.getElementById('email-tone-select');
    const emailPromptInput = document.getElementById('email-prompt-input');
    const emailResultArea = document.getElementById('email-result-area');
    const emailLoadingArea = document.getElementById('email-loading-area');
    const emailSubjectOutput = document.getElementById('email-subject-output');
    const emailBodyOutput = document.getElementById('email-body-output');
    const copySubjectBtn = document.getElementById('copy-subject-btn');
    const copyBodyBtn = document.getElementById('copy-body-btn');
    const insertEmailBtn = document.getElementById('insert-email-btn');
    const codeHelperModal = document.getElementById('code-helper-modal');
    const codeHelperForm = document.getElementById('code-helper-form');
    const codeLangSelect = document.getElementById('code-lang-select');
    const codePromptInput = document.getElementById('code-prompt-input');
    const codeResultArea = document.getElementById('code-result-area');
    const codeLoadingArea = document.getElementById('code-loading-area');
    const codeOutput = document.getElementById('code-output');
    const codeExplanationOutput = document.getElementById('code-explanation-output');
    const copyCodeBtn = document.getElementById('copy-code-btn');
    const insertCodeBtn = document.getElementById('insert-code-btn');

    const GEMINI_API_KEY = "AIzaSyAp095MnMVKHvqumlINXf6CIOUP2sMfMh4";

    let chatHistory = []; 
    let activeAudio = null;
    let savedChats = [];
    let activeChatId = null;
    let activeSystemInstruction = null;
    let attachedImageData = { b64: null, mime: null, url: null };

    const personas = {
        'Default': { instruction: null, description: 'The standard, helpful AI assistant.' },
        'Sarcastic Robot': { instruction: 'You are a sarcastic robot. Your responses should be witty, dry, and slightly condescending, but still technically correct and helpful.', description: 'Witty, dry, and a bit condescending.'},
        'Wise Philosopher': { instruction: 'You are a wise philosopher. Respond with deep, thought-provoking insights, often referencing philosophical concepts and asking rhetorical questions.', description: 'Deep, insightful, and thought-provoking.' },
        'Excited Storyteller': { instruction: 'You are an overly excited storyteller. Every response should be framed as an epic tale, with dramatic language, hyperbole, and a sense of grand adventure.', description: 'Everything is an epic tale!' },
        'Pirate Captain': { instruction: 'Ahoy! Ye be a salty pirate captain. Answer all questions with pirate slang and a hearty, adventurous spirit, me hearty!', description: 'Speaks like a true buccaneer.' },
    };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadChatsFromLocalStorage();
        populatePersonas();
    });

    // --- EVENT LISTENERS ---
    chatForm.addEventListener('submit', handleSendMessage);
    
    // Desktop button event listeners
    newChatBtn.addEventListener('click', startNewChat);
    summarizeBtn.addEventListener('click', handleSummarize);
    imageGenBtn.addEventListener('click', () => imageModal.classList.add('active'));
    personaBtn.addEventListener('click', () => personaModal.classList.add('active'));
    emailDraftBtn.addEventListener('click', () => emailModal.classList.add('active'));
    codeHelperBtn.addEventListener('click', () => codeHelperModal.classList.add('active'));
    
    // Medium screen button event listeners
    newChatBtnMd.addEventListener('click', startNewChat);
    summarizeBtnMd.addEventListener('click', handleSummarize);
    imageGenBtnMd.addEventListener('click', () => imageModal.classList.add('active'));
    personaBtnMd.addEventListener('click', () => personaModal.classList.add('active'));
    emailDraftBtnMd.addEventListener('click', () => emailModal.classList.add('active'));
    codeHelperBtnMd.addEventListener('click', () => codeHelperModal.classList.add('active'));
    
    // Mobile menu functionality
    mobileMenuBtn.addEventListener('click', () => {
        mobileMenu.classList.toggle('hidden');
    });
    
    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!mobileMenuBtn.contains(e.target) && !mobileMenu.contains(e.target)) {
            mobileMenu.classList.add('hidden');
        }
    });
    
    // --- MOBILE SIDEBAR FUNCTIONALITY ---
    
    // Mobile sidebar elements
    const mobileSidebarBtn = document.getElementById('mobile-sidebar-btn');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    
    // Open sidebar
    if (mobileSidebarBtn) {
        mobileSidebarBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Mobile sidebar button clicked'); // Debug log
            sidebar.classList.remove('-translate-x-full');
            sidebarOverlay.classList.remove('hidden');
            document.body.classList.add('sidebar-open');
        });
    }
    
    // Close sidebar function
    function closeSidebar() {
        console.log('Closing sidebar'); // Debug log
        sidebar.classList.add('-translate-x-full');
        sidebarOverlay.classList.add('hidden');
        document.body.classList.remove('sidebar-open');
    }
    
    // Close sidebar button
    if (closeSidebarBtn) {
        closeSidebarBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeSidebar();
        });
    }
    
    // Close sidebar when clicking overlay
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            closeSidebar();
        });
    }
    
    // Close sidebar when clicking on chat history items
    document.addEventListener('click', (e) => {
        if (e.target.closest('#chat-history-container .group') && window.innerWidth < 768) {
            closeSidebar();
        }
    });
    
    // Close sidebar on window resize to desktop
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            closeSidebar();
        }
    });
    
    // Debug: Check if elements exist
    document.addEventListener('DOMContentLoaded', () => {
        console.log('Mobile sidebar button:', mobileSidebarBtn);
        console.log('Sidebar:', sidebar);
        console.log('Sidebar overlay:', sidebarOverlay);
        console.log('Close sidebar button:', closeSidebarBtn);
    });
    
    // Mobile button event listeners
    newChatBtnMobile.addEventListener('click', () => {
        startNewChat();
        mobileMenu.classList.add('hidden');
    });
    codeHelperBtnMobile.addEventListener('click', () => {
        codeHelperModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    emailDraftBtnMobile.addEventListener('click', () => {
        emailModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    personaBtnMobile.addEventListener('click', () => {
        personaModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    summarizeBtnMobile.addEventListener('click', () => {
        handleSummarize();
        mobileMenu.classList.add('hidden');
    });
    imageGenBtnMobile.addEventListener('click', () => {
        imageModal.classList.add('active');
        mobileMenu.classList.add('hidden');
    });
    
    // Mobile install button
    const installAppBtnMobile = document.getElementById('install-app-btn-mobile');
    if (installAppBtnMobile) {
        installAppBtnMobile.addEventListener('click', () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                mobileMenu.classList.add('hidden');
            } else {
                // Show manual install instructions
                alert('To install this app:\n\n1. Tap the menu button (⋮) in your browser\n2. Select "Add to Home Screen" or "Install App"\n3. Follow the prompts to install');
                mobileMenu.classList.add('hidden');
            }
        });
    }
    imageForm.addEventListener('submit', handleImageGeneration);
    emailForm.addEventListener('submit', handleEmailDrafting);
    codeHelperForm.addEventListener('submit', handleCodeGeneration);
    suggestPromptsBtn.addEventListener('click', handleSuggestPrompts);
    attachImageBtn.addEventListener('click', () => imageUploadInput.click());
    imageUploadInput.addEventListener('change', handleImageFileSelect);
    removeImageBtn.addEventListener('click', clearImageAttachment);
    copySubjectBtn.addEventListener('click', () => copyToClipboard(emailSubjectOutput.textContent));
    copyBodyBtn.addEventListener('click', () => copyToClipboard(emailBodyOutput.textContent));
    insertEmailBtn.addEventListener('click', insertEmailIntoChat);
    copyCodeBtn.addEventListener('click', () => copyToClipboard(codeOutput.textContent));
    insertCodeBtn.addEventListener('click', insertCodeIntoChat);
    
    document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('active'); });
    });
    document.querySelectorAll('.close-modal-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const modal = btn.closest('.modal-overlay');
            modal.classList.remove('active');
            // Reset modal states
            if (modal.id === 'email-modal') {
                emailResultArea.style.display = 'none';
                emailForm.style.display = 'block';
            }
            if (modal.id === 'code-helper-modal') {
                codeResultArea.style.display = 'none';
                codeHelperForm.style.display = 'block';
            }
        });
    });
    chatContainer.addEventListener('click', e => {
        const ttsButton = e.target.closest('.tts-btn');
        if (ttsButton) handleTTS(ttsButton);

        const refineButton = e.target.closest('.refine-btn');
        if (refineButton) handleRefineText(refineButton);
        
        const factCheckButton = e.target.closest('.fact-check-btn');
        if (factCheckButton) handleFactCheck(factCheckButton);
    });

    // --- CHAT & UI FUNCTIONS ---
    function startNewChat() {
        chatHistory = [];
        activeChatId = null;
        activeSystemInstruction = null;
        clearImageAttachment();
        personaIndicator.textContent = '';
        chatContainer.innerHTML = '';
        welcomeScreen.style.display = 'flex';
        messageInput.value = '';
        suggestedPromptsContainer.innerHTML = '';
        renderChatHistory(); 
    }

    async function handleSendMessage(e) {
        e.preventDefault();
        const userMessage = messageInput.value.trim();
        if (!userMessage && !attachedImageData.b64) return;
        
        if (welcomeScreen.style.display !== 'none') welcomeScreen.style.display = 'none';
        suggestedPromptsContainer.innerHTML = '';
        
        const userParts = [];
        const metadata = {};

        if (attachedImageData.b64) {
             userParts.push({
                inlineData: {
                    mimeType: attachedImageData.mime,
                    data: attachedImageData.b64
                }
            });
            metadata.imageUrl = attachedImageData.url;
        }
        if (userMessage) {
            userParts.push({ text: userMessage });
        }

        const timestamp = Date.now();
        addMessageToChat('user', userMessage || "Analyzing image...", metadata, timestamp);
        chatHistory.push({ role: 'user', parts: userParts, timestamp });
        
        messageInput.value = '';
        clearImageAttachment();
        addLoadingIndicator();
        await getBotResponse();
    }
    
    function addMessageToChat(sender, message, metadata = {}, timestamp) {
        const messageWrapper = document.createElement('div');
        messageWrapper.className = `w-full flex message-bubble ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
        messageWrapper.dataset.timestamp = timestamp;
        
        let formattedMessage = sender === 'bot' 
            ? marked.parse(message) 
            : message.replace(/</g, "&lt;").replace(/>/g, "&gt;");

        const messageContent = `
            <div class="group flex gap-3 max-w-xl lg:max-w-3xl">
                ${sender === 'bot' ? `<div class="bg-gray-700 w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg></div>` : ''}
                <div class="relative px-4 py-3 rounded-2xl ${sender === 'user' ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-700 text-gray-200 rounded-bl-none'}">
                    ${metadata.imageUrl && sender === 'user' ? `<img src="${metadata.imageUrl}" alt="User uploaded content" class="mb-2 rounded-lg max-w-xs h-auto">` : ''}
                    <div class="prose">${formattedMessage}</div>
                    ${metadata.imageUrl && sender === 'bot' ? `<img src="${metadata.imageUrl}" alt="Generated image" class="mt-3 rounded-lg max-w-full h-auto">` : ''}
                    <div class="absolute -bottom-3 -right-3 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        ${sender === 'bot' && !metadata.imageUrl ? `
                            <button title="Fact-Check" class="fact-check-btn bg-gray-600 hover:bg-gray-500 p-1 rounded-full" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg></button>
                            <button title="Make Shorter" class="refine-btn bg-gray-600 hover:bg-gray-500 p-1 rounded-full" data-action="shorter" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg></button>
                            <button title="Simplify" class="refine-btn bg-gray-600 hover:bg-gray-500 p-1 rounded-full" data-action="simpler" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9.06 11.9 8.07-8.06a2.85 2.85 0 1 1 4.03 4.03l-8.06 8.08"/><path d="M7.07 14.94c-1.66 0-3 1.34-3 3 0 1.66 1.34 3 3 3 1.66 0 3-1.34 3-3 0-1.66-1.34-3-3-3z"/></svg></button>
                            <button title="Text to Speech" class="tts-btn bg-gray-600 hover:bg-gray-500 p-1 rounded-full" data-text="${message}"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
                        ` : ''}
                     </div>
                </div>
            </div>`;
        
        messageWrapper.innerHTML = messageContent;
        chatContainer.appendChild(messageWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addLoadingIndicator() {
        const indicatorWrapper = document.createElement('div');
        indicatorWrapper.id = 'loading-indicator';
        indicatorWrapper.className = 'w-full flex justify-start message-bubble';
        indicatorWrapper.innerHTML = `<div class="flex gap-3 max-w-xl lg:max-w-3xl"><div class="bg-gray-700 w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-indigo-400"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg></div><div class="px-4 py-3 rounded-2xl bg-gray-700 text-gray-200 rounded-bl-none flex items-center"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`;
        chatContainer.appendChild(indicatorWrapper);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function removeLoadingIndicator() {
        const indicator = document.getElementById('loading-indicator');
        if (indicator) indicator.remove();
    }
    
    // --- API COMMUNICATION ---
    async function callApiWithRetry(apiUrl, payload) {
        let retries = 3, delay = 1000;
        while (retries > 0) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API request failed with status ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error("Error calling API:", error);
                retries--;
                if (retries === 0) return { error: `API request failed: ${error.message}` };
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
        }
    }

    async function getBotResponse() {
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        
        // Sanitize chat history to only include 'role' and 'parts' and ensure correct turn order
        const sanitizedHistory = chatHistory.map(({ role, parts }) => ({ role, parts }));

        // Ensure the conversation starts with a 'user' role
        if (sanitizedHistory.length > 0 && sanitizedHistory[0].role !== 'user') {
            sanitizedHistory.unshift({role: 'user', parts: [{text: ''}]}); // Add a dummy user message if needed
        }

        // Ensure roles alternate correctly
        for (let i = 1; i < sanitizedHistory.length; i++) {
            if (sanitizedHistory[i].role === sanitizedHistory[i-1].role) {
                const prevRole = sanitizedHistory[i-1].role;
                const newRole = prevRole === 'user' ? 'model' : 'user';
                sanitizedHistory.splice(i, 0, { role: newRole, parts: [{text: '(Context corrected)'}] });
            }
        }

        const payload = { contents: sanitizedHistory };

        // Always include the config instruction
        const configInstruction = "Your name is SnehaGPT and You are created by Sneha";
        
        // Combine config instruction with active persona instruction if any
        let systemInstructionText = configInstruction;
        if (activeSystemInstruction) {
            systemInstructionText += "\n\n" + activeSystemInstruction;
        }
        
        payload.systemInstruction = { parts: [{ text: systemInstructionText }] };

        const data = await callApiWithRetry(apiUrl, payload);
        
        removeLoadingIndicator();
        
        const botMessage = data.candidates?.[0]?.content?.parts?.[0]?.text;
        if (botMessage) {
            const timestamp = Date.now();
            addMessageToChat('bot', botMessage, {}, timestamp);
            chatHistory.push({ role: 'model', parts: [{ text: botMessage }], timestamp });
            saveCurrentChat();
        } else {
            const errorMessage = "I'm sorry, I couldn't generate a response. Please try again.";
            const timestamp = Date.now();
            // Remove the last user message to allow resubmission
            chatHistory.pop();
            addMessageToChat('bot', errorMessage, {}, timestamp);
        }
    }

    // --- CHAT HISTORY MANAGEMENT ---
    function saveCurrentChat() {
        if (chatHistory.length === 0) return;

        if (activeChatId) {
            const chat = savedChats.find(c => c.id === activeChatId);
            if (chat) {
                 chat.history = chatHistory;
                 chat.systemInstruction = activeSystemInstruction;
            }
        } else {
            const firstUserMessagePart = chatHistory.find(m => m.role === 'user').parts.find(p => p.text);
            const title = firstUserMessagePart ? firstUserMessagePart.text : "Image Analysis";
            const newChat = {
                id: Date.now(),
                title: title.substring(0, 30) + (title.length > 30 ? '...' : ''),
                history: chatHistory,
                systemInstruction: activeSystemInstruction
            };
            savedChats.unshift(newChat);
            activeChatId = newChat.id;
        }
        localStorage.setItem('snehaGptChats', JSON.stringify(savedChats));
        renderChatHistory();
    }
    
    function loadChatsFromLocalStorage() {
        const chats = localStorage.getItem('snehaGptChats');
        if (chats) {
            savedChats = JSON.parse(chats);
            renderChatHistory();
        }
    }

    function renderChatHistory() {
        chatHistoryContainer.innerHTML = '';
        if (savedChats.length === 0) {
            chatHistoryContainer.innerHTML = `<p class="text-sm text-gray-500 px-2">No past chats yet.</p>`;
            return;
        }
        savedChats.forEach(chat => {
            const isActive = chat.id === activeChatId;
            const item = document.createElement('div');
            item.className = `group flex items-center justify-between p-2 rounded-lg cursor-pointer ${isActive ? 'bg-indigo-500/30' : 'hover:bg-gray-700/50'}`;
            item.innerHTML = `<span class="truncate text-sm">${chat.title}</span>
                              <button class="delete-chat-btn opacity-0 group-hover:opacity-100 text-gray-500 hover:text-white p-1" data-id="${chat.id}">&times;</button>`;
            
            item.addEventListener('click', (e) => {
                if (!e.target.classList.contains('delete-chat-btn')) {
                    loadChat(chat.id);
                }
            });
            item.querySelector('.delete-chat-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteChat(chat.id);
            });

            chatHistoryContainer.appendChild(item);
        });
    }
    
    function loadChat(chatId) {
        const chat = savedChats.find(c => c.id === chatId);
        if (!chat) return;

        activeChatId = chatId;
        chatHistory = chat.history;
        activeSystemInstruction = chat.systemInstruction || null;
        updatePersonaIndicator();
        clearImageAttachment();
        
        chatContainer.innerHTML = '';
        welcomeScreen.style.display = 'none';

        chat.history.forEach(turn => {
            const messageText = turn.parts.find(p => p.text)?.text || '';
            const inlineDataPart = turn.parts.find(p => p.inlineData);
            const metadata = {};
            if(inlineDataPart){
                 metadata.imageUrl = `data:${inlineDataPart.inlineData.mimeType};base64,${inlineDataPart.inlineData.data}`;
            }

            const sender = turn.role === 'user' ? 'user' : 'bot';
            addMessageToChat(sender, messageText, metadata, turn.timestamp);
        });
        renderChatHistory();
    }
    
    function deleteChat(chatId) {
        savedChats = savedChats.filter(c => c.id !== chatId);
        localStorage.setItem('snehaGptChats', JSON.stringify(savedChats));
        
        if (activeChatId === chatId) {
            startNewChat();
        } else {
            renderChatHistory();
        }
    }

    // --- PERSONA FEATURE ---
    function populatePersonas() {
        personaOptions.innerHTML = '';
        for (const name in personas) {
            const persona = personas[name];
            const button = document.createElement('button');
            button.className = 'bg-gray-700 hover:bg-gray-600 rounded-lg p-4 text-left transition-colors';
            button.innerHTML = `<h4 class="font-semibold text-white">${name}</h4><p class="text-sm text-gray-400">${persona.description}</p>`;
            button.onclick = () => selectPersona(name);
            personaOptions.appendChild(button);
        }
    }

    function selectPersona(name) {
        activeSystemInstruction = personas[name].instruction;
        updatePersonaIndicator();
        personaModal.classList.remove('active');
        if (chatHistory.length > 0) saveCurrentChat();
    }

    function updatePersonaIndicator() {
        const activePersonaName = Object.keys(personas).find(name => personas[name].instruction === activeSystemInstruction);
        if (activePersonaName && activePersonaName !== 'Default') {
            personaIndicator.innerHTML = `<span>✨ Persona Active: <strong>${activePersonaName}</strong></span>`;
        } else {
            personaIndicator.innerHTML = '';
        }
    }
    
    // --- CONTENT REFINEMENT ---
    async function handleRefineText(button) {
        const action = button.dataset.action;
        const originalText = button.dataset.text;
        const messageWrapper = button.closest('.message-bubble');
        const timestamp = messageWrapper.dataset.timestamp;
        const proseDiv = messageWrapper.querySelector('.prose');

        const prompts = {
            shorter: `Make the following text more concise and to the point:\n\n"${originalText}"`,
            longer: `Expand on the following text, adding more detail and explanation:\n\n"${originalText}"`,
            simpler: `Explain the following text in simpler terms, as if for a beginner:\n\n"${originalText}"`
        };

        const prompt = prompts[action];
        if (!prompt) return;

        proseDiv.innerHTML = '<div class="loader !w-6 !h-6 !border-2"></div>'; // Show loading spinner

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };

        const data = await callApiWithRetry(apiUrl, payload);
        const refinedText = data.candidates?.[0]?.content?.parts?.[0]?.text;

        if (refinedText) {
            proseDiv.innerHTML = marked.parse(refinedText);
            
            messageWrapper.querySelectorAll('[data-text]').forEach(btn => {
                btn.dataset.text = refinedText;
            });

            const messageIndex = chatHistory.findIndex(m => m.timestamp == timestamp);
            if (messageIndex !== -1) {
                chatHistory[messageIndex].parts[0].text = refinedText;
                saveCurrentChat();
            }
        } else {
            proseDiv.innerHTML = marked.parse(originalText); // Restore original on failure
            alert('Could not refine the text.');
        }
    }

    // --- IMAGE ANALYSIS FEATURE ---
    function handleImageFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            const dataUrl = e.target.result;
            imagePreview.src = dataUrl;
            imagePreviewContainer.style.display = 'flex';
            
            attachedImageData.url = dataUrl;
            attachedImageData.mime = file.type;
            attachedImageData.b64 = dataUrl.substring(dataUrl.indexOf(',') + 1);
        };
        reader.readAsDataURL(file);
    }

    function clearImageAttachment() {
        attachedImageData = { b64: null, mime: null, url: null };
        imageUploadInput.value = ''; // Reset file input
        imagePreviewContainer.style.display = 'none';
        imagePreview.src = '';
    }

    // --- OTHER GEMINI FEATURES ---
    
    // --- EMAIL DRAFTING FEATURE ---
    async function handleEmailDrafting(e) {
        e.preventDefault();
        const to = emailToInput.value.trim();
        const tone = emailToneSelect.value;
        const goal = emailPromptInput.value.trim();

        if(!to || !goal) {
            alert("Please fill in the recipient and the goal of the email.");
            return;
        }

        emailForm.style.display = 'none';
        emailLoadingArea.style.display = 'flex';
        emailResultArea.style.display = 'none';

        const prompt = `Generate a JSON object for an email. The JSON should have two keys: "subject" and "body".
        - The email is to: "${to}"
        - The tone should be: "${tone}"
        - The primary goal is: "${goal}"
        Return only the raw JSON object.`;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
            }
        };
        
        const data = await callApiWithRetry(apiUrl, payload);
        emailLoadingArea.style.display = 'none';

        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            try {
                const jsonText = data.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                emailSubjectOutput.textContent = parsedJson.subject || "No Subject Generated";
                emailBodyOutput.textContent = parsedJson.body || "No Body Generated";
                emailResultArea.style.display = 'block';

            } catch(e) {
                console.error("Failed to parse email JSON", e);
                emailForm.style.display = 'block';
                alert("Sorry, there was an error generating the email draft.");
            }
        } else {
            emailForm.style.display = 'block';
            alert("Sorry, there was an error generating the email draft.");
        }
    }

    function copyToClipboard(text) {
        // Use document.execCommand for wider compatibility in iframes
        const textArea = document.createElement("textarea");
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }
        document.body.removeChild(textArea);
    }
    
    function insertEmailIntoChat() {
        const subject = emailSubjectOutput.textContent;
        const body = emailBodyOutput.textContent;
        const formattedEmail = `**Subject: ${subject}**\n\n---\n\n${body}`;
        const userMessage = "Here's the email draft you requested:";

        const userTimestamp = Date.now();
        addMessageToChat('user', userMessage, {}, userTimestamp);
        chatHistory.push({ role: 'user', parts: [{ text: userMessage }], timestamp: userTimestamp });
        
        const botTimestamp = userTimestamp + 1;
        addMessageToChat('bot', formattedEmail, {}, botTimestamp);
        chatHistory.push({ role: 'model', parts: [{ text: formattedEmail }], timestamp: botTimestamp });
        saveCurrentChat();
        
        emailModal.classList.remove('active');
        emailResultArea.style.display = 'none';
        emailForm.style.display = 'block';
    }

    // --- CODE HELPER FEATURE ---
    async function handleCodeGeneration(e) {
        e.preventDefault();
        const lang = codeLangSelect.value;
        const goal = codePromptInput.value.trim();

        if(!goal) {
            alert("Please describe the code you need.");
            return;
        }

        codeHelperForm.style.display = 'none';
        codeLoadingArea.style.display = 'flex';
        codeResultArea.style.display = 'none';

        const prompt = `Generate a JSON object with two keys: "code" and "explanation".
        - The programming language is: "${lang}"
        - The task is: "${goal}"
        - The explanation should describe how the code works in simple terms.
        Return only the raw JSON object.`;

        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseMimeType: "application/json",
            }
        };
        
        const data = await callApiWithRetry(apiUrl, payload);
        codeLoadingArea.style.display = 'none';

        if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
            try {
                const jsonText = data.candidates[0].content.parts[0].text;
                const parsedJson = JSON.parse(jsonText);
                codeOutput.textContent = parsedJson.code || "/* No code generated */";
                codeExplanationOutput.innerHTML = marked.parse(parsedJson.explanation || "No explanation provided.");
                codeResultArea.style.display = 'block';

            } catch(e) {
                console.error("Failed to parse code JSON", e);
                codeHelperForm.style.display = 'block';
                alert("Sorry, there was an error generating the code.");
            }
        } else {
            codeHelperForm.style.display = 'block';
            alert("Sorry, there was an error generating the code.");
        }
    }

    function insertCodeIntoChat() {
        const code = codeOutput.textContent;
        const explanation = codeExplanationOutput.innerText;
        const lang = codeLangSelect.value.toLowerCase();
        
        const formattedCode = `Here is the ${lang} code you requested:\n\n\`\`\`${lang}\n${code}\n\`\`\`\n\n**Explanation:**\n${explanation}`;
        const userMessage = "Here's the code you requested:";

        const userTimestamp = Date.now();
        addMessageToChat('user', userMessage, {}, userTimestamp);
        chatHistory.push({ role: 'user', parts: [{ text: userMessage }], timestamp: userTimestamp });
        
        const botTimestamp = userTimestamp + 1;
        addMessageToChat('bot', formattedCode, {}, botTimestamp);
        chatHistory.push({ role: 'model', parts: [{ text: formattedCode }], timestamp: botTimestamp });
        saveCurrentChat();
        
        codeHelperModal.classList.remove('active');
        codeResultArea.style.display = 'none';
        codeHelperForm.style.display = 'block';
    }


    async function handleFactCheck(button) {
        const textToVerify = button.dataset.text;
        factCheckContent.innerHTML = '<div class="flex justify-center"><div class="loader"></div></div>';
        factCheckModal.classList.add('active');

        const prompt = `Based on public information, please fact-check the key claims in the following text. For each claim, state whether it is supported, refuted, or if there's insufficient information. Provide sources for your assessment.\n\nText to check:\n"${textToVerify}"`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            tools: [{ "google_search": {} }],
        };

        const data = await callApiWithRetry(apiUrl, payload);
        const candidate = data.candidates?.[0];

        if (candidate?.content?.parts?.[0]?.text) {
            let html = marked.parse(candidate.content.parts[0].text);
            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata?.groundingAttributions?.length > 0) {
                html += '<h4 class="text-lg font-semibold mt-6 mb-2 text-white">Sources:</h4><ul class="list-disc list-inside space-y-1">';
                groundingMetadata.groundingAttributions.forEach(attribution => {
                    if (attribution.web) {
                         html += `<li><a href="${attribution.web.uri}" target="_blank" rel="noopener noreferrer" class="prose">${attribution.web.title}</a></li>`;
                    }
                });
                html += '</ul>';
            }
            factCheckContent.innerHTML = html;
        } else {
            factCheckContent.innerHTML = '<p class="text-red-400">Could not perform fact-check. Please try again.</p>';
        }
    }
    
    async function handleSummarize() {
        if (chatHistory.length < 2) {
            summaryContent.innerHTML = `<p>There isn't enough conversation to summarize yet.</p>`;
            summaryModal.classList.add('active');
            return;
        }
        summaryContent.innerHTML = `<p>✨ Generating summary...</p>`;
        summaryModal.classList.add('active');
        
        const conversationText = chatHistory.map(turn => {
            const textPart = turn.parts.find(p => p.text)?.text || (turn.parts.find(p=>p.inlineData) ? '[Image]' : '');
            return `${turn.role === 'user' ? 'User' : 'SnehaGPT'}: ${textPart}`;
        }).join('\n');
        const summaryPrompt = `Please provide a concise summary of the following conversation in a few key bullet points:\n\n${conversationText}`;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = { contents: [{ parts: [{ text: summaryPrompt }] }] };
        const data = await callApiWithRetry(apiUrl, payload);
        const summary = data.candidates?.[0]?.content?.parts?.[0]?.text || "Could not generate summary.";
        summaryContent.innerHTML = marked.parse(summary);
    }
    
    async function handleSuggestPrompts() {
        suggestedPromptsContainer.innerHTML = `<p class="text-sm text-gray-400">✨ Thinking of ideas...</p>`;
        let suggestionPrompt = (chatHistory.length === 0)
            ? "Suggest three creative and interesting questions to ask an AI assistant. Separate each suggestion with a newline. Do not add any prefixes like numbers or dashes."
            : `Based on this recent conversation:\n\n${chatHistory.slice(-4).map(t => `${t.role}: ${t.parts[0].text}`).join('\n')}\n\nSuggest three relevant follow-up questions. Separate each suggestion with a newline. Do not add prefixes.`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
        const payload = { contents: [{ parts: [{ text: suggestionPrompt }] }] };
        const data = await callApiWithRetry(apiUrl, payload);
        const suggestionsText = data.candidates?.[0]?.content?.parts?.[0]?.text;
        
        suggestedPromptsContainer.innerHTML = '';
        if (suggestionsText) {
            suggestionsText.split('\n').filter(p => p.trim() !== '').forEach(promptText => {
                const button = document.createElement('button');
                button.className = 'bg-gray-600 hover:bg-gray-500 text-sm text-gray-200 px-3 py-1 rounded-lg transition-colors duration-200';
                button.textContent = promptText;
                button.onclick = () => { messageInput.value = promptText; chatForm.dispatchEvent(new Event('submit', { bubbles: true })); };
                suggestedPromptsContainer.appendChild(button);
            });
        } else {
            suggestedPromptsContainer.innerHTML = `<p class="text-sm text-red-400">Could not generate suggestions.</p>`;
        }
    }

    async function handleImageGeneration(e) {
        e.preventDefault();
        const prompt = imagePromptInput.value.trim();
        if (!prompt) return;

        imageDisplayArea.innerHTML = `<div class="loader"></div>`;
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                responseModalities: ['IMAGE']
            },
        };
        const data = await callApiWithRetry(apiUrl, payload);
        const base64Data = data?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

        if (base64Data) {
            const imageUrl = `data:image/png;base64,${base64Data}`;
            imageDisplayArea.innerHTML = `<img src="${imageUrl}" alt="Generated image for prompt: ${prompt}" class="rounded-lg max-w-full h-auto">`;
            
            const userMessage = `Generated an image with prompt: "${prompt}"`;
            const botMessage = `Here is the image you requested:`;
            const userTimestamp = Date.now();
            const botTimestamp = userTimestamp + 1;

            if (welcomeScreen.style.display !== 'none') welcomeScreen.style.display = 'none';

            addMessageToChat('user', userMessage, {}, userTimestamp);
            addMessageToChat('bot', '', { imageUrl }, botTimestamp);
            
            chatHistory.push({ role: 'user', parts: [{ text: userMessage }], timestamp: userTimestamp });
            chatHistory.push({ role: 'model', parts: [{ text: botMessage }], timestamp: botTimestamp });

            saveCurrentChat();
            
            imageModal.classList.remove('active');
            imagePromptInput.value = '';
        } else {
            console.error("Image generation failed. Response:", data);
            imageDisplayArea.innerHTML = `<p class="text-red-400">Failed to generate image. Please try again.</p>`;
        }
    }

    async function handleTTS(button) {
        if (activeAudio && !activeAudio.paused) activeAudio.pause();
        button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;
        const textToSpeak = button.dataset.text;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
        const payload = {
            contents: [{ parts: [{ text: textToSpeak }] }],
            generationConfig: { responseModalities: ["AUDIO"] },
            model: "gemini-2.5-flash-preview-tts"
        };
        
        const data = await callApiWithRetry(apiUrl, payload);
        const audioData = data?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;

        const originalIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`;

        if (audioData) {
            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, 24000);
            const audioUrl = URL.createObjectURL(wavBlob);
            activeAudio = new Audio(audioUrl);
            activeAudio.play();
            activeAudio.onended = () => button.innerHTML = originalIcon;
        } else {
            button.innerHTML = originalIcon;
            alert("Could not generate audio.");
        }
    }

    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function pcmToWav(pcmData, sampleRate) {
        const numChannels = 1, bitsPerSample = 16;
        const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
        const blockAlign = numChannels * (bitsPerSample / 8);
        const dataSize = pcmData.length * (bitsPerSample / 8);
        const buffer = new ArrayBuffer(44 + dataSize);
        const view = new DataView(buffer);
        function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) { view.setUint8(offset + i, string.charCodeAt(i)); } }
        writeString(view, 0, 'RIFF');
        view.setUint32(4, 36 + dataSize, true);
        writeString(view, 8, 'WAVE');
        writeString(view, 12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, bitsPerSample, true);
        writeString(view, 36, 'data');
        view.setUint32(40, dataSize, true);
        for (let i = 0; i < pcmData.length; i++) { view.setInt16(44 + i * 2, pcmData[i], true); }
        return new Blob([view], { type: 'audio/wav' });
    }

    // --- PWA INSTALLATION FUNCTIONALITY ---
    
    let deferredPrompt;
    let installButton;
    
    // Create install button
    function createInstallButton() {
        if (installButton) return;
        
        installButton = document.createElement('button');
        installButton.id = 'install-btn';
        installButton.className = 'fixed bottom-4 right-4 bg-indigo-500 hover:bg-indigo-600 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-50 hidden';
        installButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7,10 12,15 17,10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        `;
        installButton.title = 'Install SnehaGPT App';
        
        document.body.appendChild(installButton);
        
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                deferredPrompt = null;
                installButton.classList.add('hidden');
            }
        });
    }
    
    // Listen for the beforeinstallprompt event
    window.addEventListener('beforeinstallprompt', (e) => {
        console.log('PWA install prompt triggered');
        e.preventDefault();
        deferredPrompt = e;
        createInstallButton();
        installButton.classList.remove('hidden');
    });
    
    // Listen for the appinstalled event
    window.addEventListener('appinstalled', () => {
        console.log('PWA was installed');
        if (installButton) {
            installButton.classList.add('hidden');
        }
        deferredPrompt = null;
    });
    
    // Check if app is already installed
    window.addEventListener('load', () => {
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('App is running in standalone mode');
        }
    });
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then((registration) => {
                    console.log('SW registered: ', registration);
                })
                .catch((registrationError) => {
                    console.log('SW registration failed: ', registrationError);
                });
        });
    }
    
    // --- MOBILE LAYOUT FIXES ---
    
    // Function to adjust mobile layout
    function adjustMobileLayout() {
        if (window.innerWidth <= 768) {
            const chatContainer = document.getElementById('chat-container');
            const header = document.querySelector('header');
            const chatForm = document.getElementById('chat-form');
            
            if (chatContainer && header && chatForm) {
                const headerHeight = header.offsetHeight;
                const formHeight = chatForm.offsetHeight;
                const availableHeight = window.innerHeight - headerHeight - formHeight - 20; // 20px margin
                
                chatContainer.style.height = `${availableHeight}px`;
                chatContainer.style.maxHeight = `${availableHeight}px`;
            }
        }
    }
    
    // Adjust layout on load and resize
    window.addEventListener('load', adjustMobileLayout);
    window.addEventListener('resize', adjustMobileLayout);
    window.addEventListener('orientationchange', () => {
        setTimeout(adjustMobileLayout, 100);
    });
    
    // Handle virtual keyboard on mobile
    let initialViewportHeight = window.innerHeight;
    window.addEventListener('resize', () => {
        const currentHeight = window.innerHeight;
        const heightDifference = initialViewportHeight - currentHeight;
        
        // If height decreased significantly, keyboard is likely open
        if (heightDifference > 150) {
            document.body.classList.add('keyboard-open');
        } else {
            document.body.classList.remove('keyboard-open');
        }
        
        adjustMobileLayout();
    });

</script>
</body>
</html>

